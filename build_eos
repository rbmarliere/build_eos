#!/usr/bin/env zsh

export WASM_LLVM_CONFIG=$USER_GIT_ROOT/llvm/release/bin/llvm-config

if [[ ! -d $USER_GIT_ROOT/eos ]]; then
    git clone --recursive git@github.com:EOSIO/eos.git $USER_GIT_ROOT/eos
fi

cd $USER_GIT_ROOT/eos
tag=${tag:-master}
git clean -fdx
git fetch --all
git checkout -b $tag
git pull origin $tag
git submodule update --recursive
mkdir {build,release}
cd build

cmake \
    -DBOOST_LIBRARYDIR=$USER_GIT_ROOT/boost/release/lib \
    -DBOOST_ROOT=$USER_GIT_ROOT/boost \
    -DBINARYEN_ROOT=$USER_GIT_ROOT/binaryen/release \
    -DCMAKE_INSTALL_PREFIX=$USER_GIT_ROOT/eos/release \
    -DCMAKE_PREFIX_PATH=$USER_GIT_ROOT/llvm/release \
    -DCMAKE_C_COMPILER=$USER_GIT_ROOT/llvm/release/bin/clang \
    -DSecp256k1_ROOT_DIR=$USER_GIT_ROOT/secp256k1-zkp/release \
    ..

make -j$(nproc) install

